---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# solong

[![Travis-CI Build Status](https://travis-ci.org/SCAR/solong.svg?branch=master)](https://travis-ci.org/SCAR/solong)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/SCAR/solong?branch=master&svg=true)](https://ci.appveyor.com/project/SCAR/solong)
[![codecov](https://codecov.io/gh/SCAR/solong/branch/master/graph/badge.svg)](https://codecov.io/gh/SCAR/solong)

Overview
--------

This R package provides allometric equations that relate the body size of Southern Ocean taxa to their body part measurements.


Installing
----------

```{r, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("SCAR/solong")
```

Usage
-----

```{r include=FALSE}
devtools::load_all()
library(dplyr)
```


```{r eval=FALSE,message=FALSE, warning=FALSE}
library(solong)
library(dplyr)
```


Let's say we have some measurements of *Architeuthis dux* squid beaks:

```{r}
x <- data.frame(LRL=c(11.3,13.9),species=c("Architeuthis dux"),
  stringsAsFactors=FALSE)
x
```

It doesn't matter what the column names are, but we do need to set the properties of the columns so that `solong` can find the appropriate data to use in each allometric equation. Here we've measured lower rostral length, so:

```{r}
x$LRL <- sol_set_property(x$LRL,"lower rostral length")
```

Now we can apply allometric equations to our data. What equations do we have available for our species of interest?

```{r}
sol_equations() %>%
  filter(taxon_name=="Architeuthis dux")
```

Here we use the equation with ID `342218_ML_Roel2000`, which is from Roeleveld (2000) and gives the mantle length of *Architeuthis dux* based on the lower rostral length.

This equation can be applied to to all rows:
```{r}
sol_allometry(x,c("342218_ML_Roel2000"))
```

Or we can apply a different equation to each row. Here we could use different allometric equations for mantle length:
```{r}
xa <- sol_allometry(x,c("342218_ML_Roel2000","342218_ML_Clar1986"))
xa
```

The `allometric_value` column contains the values that have been estimated, and the `allometric_property` column gives the name of the property that has been estimated.

We can also see that the returned `allometric_value` is of that specific property, with appropriate units:
```{r}
sol_get_property(xa$allometric_value)
units(xa$allometric_value)
```

## Edge cases

We can apply equations that use different inputs, provided that they estimate the same output property. For example, equation `342218_mass_Clar1986` estimates the mass of the squid *Architeuthis dux* based on lower rostral length measurements:

```{r}
sol_equation("342218_mass_Clar1986")
```

And equation `195932_mass_GaBu1988` estimates the mass of male Weddell seals based on their standard length:

```{r}
sol_equation("195932_mass_GaBu1988")
```
Note that this equation estimates mass in kg, whereas `342218_mass_Clar1986` estimates mass in g. We can apply the two equations together to a single data set:

```{r}
x <- tibble(LRL=c(11.3,NA),species=c("Architeuthis dux","Leptonychotes weddellii"),SL=c(NA,175)) %>%
  mutate(LRL=sol_set_property(LRL,"lower rostral length"),
  SL=sol_set_property(SL,"standard length","cm"))

xa <- sol_allometry(x,c("342218_mass_Clar1986","195932_mass_GaBu1988"))
xa %>% select(species,allometric_property,allometric_value)
```

The output values are of property "mass" and have all been provided in g (because the output column `allometric value` must have a single set of units):

```{r}
sol_get_property(xa$allometric_value)
units(xa$allometric_value)
```


If we try to apply equations that estimate different properties, we will get a warning:
```{r}
xa <- sol_allometry(x,c("342218_ML_Roel2000","342218_mass_Clar1986"))
xa %>% select(species,allometric_property,allometric_value)
```

And while the `allometric_property` column still says which property was estimated for each row, the property type and units of the returned `allometric_value` will not be set, because they are not consistent across the different equations:
```{r}
sol_get_property(xa$allometric_value)
```

## Missing information

What happens if we don't have the required information in our data to use a particular equation? The `234631_SL~OL_WiMc1990` equation is for fish length, and requires otolith length (not present in our test data).

```{r}
tryCatch(
  sol_allometry(x,"234631_SL~OL_WiMc1990"),
  error=function(e) conditionMessage(e)
)
```

## Packaged equations

```{r include=FALSE}
eN <- sol_equations() %>% mutate(is_fish=grepl("WiMc1990",equation_id)) %>% group_by(is_fish,return_property) %>% summarize(N=n())
```
The package currently includes `r sum(eN$N)` equations, covering mostly cephalopods and fish.

## Taxonomy

Equations are registered against *taxon_name* and *taxon_aphia_id* (the species identifier in the World Register of Marine Species). The *taxon_aphia_id* may be more reliable than species names, which can change over time. Users might like to look at the [worrms package](https://cran.r-project.org/package=worrms) for interacting with the World Register of Marine Species.


